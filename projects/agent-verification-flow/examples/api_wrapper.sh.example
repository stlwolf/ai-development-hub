#!/bin/bash
# 認証方式自動選択ラッパー
#
# JWT認証を試し、401エラーの場合はSession認証にフォールバック
#
# 使用方法:
#   ./api_wrapper.sh GET /api/users
#   ./api_wrapper.sh POST /api/items -d '{"name":"test"}'
#
# 注意:
#   - JWT認証(.token)とSession認証(.session)の両方が設定されている前提
#   - 401以外のエラー（400, 403, 500等）はフォールバックしない

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
API_CALL="${SCRIPT_DIR}/../scripts/api_call.sh"
SESSION_API="${SCRIPT_DIR}/../scripts/session_api.sh"

# 色付き出力
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1" >&2; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1" >&2; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

# 引数チェック
if [[ $# -lt 2 ]]; then
    echo "使用方法: $(basename "$0") <METHOD> <PATH> [OPTIONS]" >&2
    exit 1
fi

METHOD="$1"
PATH_ARG="$2"
shift 2

# JWT認証で試行
log_info "JWT認証で試行中: $METHOD $PATH_ARG"

# 一時ファイルでレスポンスを保存
RESPONSE_FILE=$(mktemp)
HTTP_CODE=$("$API_CALL" "$METHOD" "$PATH_ARG" "$@" --status-only 2>/dev/null) || HTTP_CODE="error"

if [[ "$HTTP_CODE" == "401" ]]; then
    log_warn "JWT認証失敗 (401)、Session認証で再試行..."
    
    # Session認証にフォールバック
    "$SESSION_API" "$METHOD" "$PATH_ARG" "$@"
    exit $?
elif [[ "$HTTP_CODE" == "error" ]]; then
    log_warn "JWT認証でエラー、Session認証で再試行..."
    
    # Session認証にフォールバック
    "$SESSION_API" "$METHOD" "$PATH_ARG" "$@"
    exit $?
else
    # JWT認証成功、結果を出力
    "$API_CALL" "$METHOD" "$PATH_ARG" "$@"
    exit $?
fi
